<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26" zv="IRIS for Windows (x86-64) 2020.1 (Build 209U)" ts="2020-05-17 22:10:06">
<Class name="PEX.Webinar.AWSDemo.S3Operation">
<Description>
Operacion que se conecta a AWS S3</Description>
<Language>objectscript</Language>
<Super>Ens.BusinessOperation</Super>
<TimeChanged>65516,72777.244748</TimeChanged>
<TimeCreated>65516,61863.083279</TimeCreated>

<Parameter name="ADAPTER">
<Default>EnsLib.PEX.OutboundAdapter</Default>
</Parameter>

<Property name="Adapter">
<Type>EnsLib.PEX.OutboundAdapter</Type>
</Property>

<Parameter name="INVOCATION">
<Default>Queue</Default>
</Parameter>

<Method name="PutText">
<Description>
Puts the text as text/plain object in S3 and returns the HttpStatus code as System.Net.HttpStatusCode</Description>
<FormalSpec>pRequest:PEX.Webinar.AWSDemo.S3PutTextReq,*pResponse:Ens.StringResponse</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[

	#DIM tSC as %Status=$$$OK
	#DIM errObj as %Exception.AbstractException
	try {
		set tHttpResponseCode=..Adapter.PutText(pRequest.ObjectName,pRequest.Data)
		set pResponse=##class(Ens.StringResponse).%New()
		set pResponse.StringValue=tHttpResponseCode
	}catch (errObj) {
		set tSC=errObj.AsStatus()
	}
	quit tSC
]]></Implementation>
</Method>

<Method name="PutStream">
<Description>
Oututs the Stream to S3</Description>
<FormalSpec>pRequest:Ens.StreamContainer,*pResponse:Ens.StringResponse</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[

	#DIM tSC as %Status=$$$OK
	#DIM errObj as %Exception.AbstractException
	#DIM tNameIn,tFileName,tHttpResponseCode
	try {
		///Get the Original Filename, and use it as Key on AWS S3
		Set tNameIn=##class(%File).GetFilename(pRequest.OriginalFilename)
		//Save it to a temporary FileStream to use from the .NET code
		If ( pRequest.Stream.%Extends("%Library.GlobalStreamAdaptor")||
		     pRequest.Stream.%Extends("%Stream.GlobalCharacter")
		   )
		   {
			#; copy to a global stream in a new container
			Set tStream=##class(%FileBinaryStream).%New()
			Merge tStream.Attributes=pRequest.Stream.Attributes
			Set tSC=tStream.CopyFrom(pRequest.Stream)
			$$$THROWONERROR(tSC,tStream.SaveStream())
			set tFileName=tStream.Filename
		} Else {
			set tFileName=pRequest.OriginalFilename
			
		}
		$$$TRACE("Calling PutStream with key="+tNameIn+", filename="+tFileName)
		
		///Use MultiParts Upload for files >5MB as per AWS Recomendations
		
		if (pRequest.Stream.Size>5*1204*1024){
			do ..Adapter.PutStreamMultiParts(tNameIn,tFileName)
			set tHttpResponseCode="OK" 
		}else {
			set tHttpResponseCode=..Adapter.PutStream(tNameIn,tFileName)
		}
		
		set pResponse=##class(Ens.StringResponse).%New()
		set pResponse.StringValue=tHttpResponseCode
	}catch (errObj) {
		set tSC=errObj.AsStatus()
	}
	quit tSC
]]></Implementation>
</Method>

<XData name="MessageMap">
<Data><![CDATA[
<MapItems>
	<MapItem MessageType="PEX.Webinar.AWSDemo.S3PutTextReq"> 
		<Method>PutText</Method>
	</MapItem>
	<MapItem MessageType="Ens.StreamContainer"> 
		<Method>PutStream</Method>
	</MapItem>
	
</MapItems>
]]></Data>
</XData>
</Class>


<Class name="PEX.Webinar.AWSDemo.S3Production">
<Super>Ens.Production</Super>
<TimeChanged>65516,79747.210908</TimeChanged>
<TimeCreated>65512,70754.560077</TimeCreated>

<XData name="ProductionDefinition">
<Data><![CDATA[
<Production Name="PEX.Webinar.AWSDemo.S3Production" TestingEnabled="true" LogGeneralTraceEvents="false">
  <Description>Una Production Con Componentes basados en librerias de terceros</Description>
  <ActorPoolSize>0</ActorPoolSize>
  <Setting Target="Adapter" Name="ShutdownTimeout">10</Setting>
  <Item Name="S3Operation" Category="" ClassName="PEX.Webinar.AWSDemo.S3Operation" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
    <Setting Target="Adapter" Name="%gatewayExtraClasspaths">C:\webinar\webinar-PEX\AWS\PEX.AWS\bin\Debug\netstandard2.0\PEX.AWS.dll;C:\Users\pyd\.nuget\packages\awssdk.s3\3.5.0-beta\lib\net45\AWSSDK.S3.DLL</Setting>
    <Setting Target="Adapter" Name="%gatewayPort">44445</Setting>
    <Setting Target="Adapter" Name="%remoteClassname">PEX.AWS.S3OutboundAdapter</Setting>
    <Setting Target="Adapter" Name="%remoteSettings">awsAccessKeyId=AKIA6F7BHN5R63AZR3XJ
awsSecretAccessKey=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
awsBucket=iris-webinar
awsRegion=eu-west-1</Setting>
  </Item>
  <Item Name="EnsLib.DotNetGateway.Service" Category="" ClassName="EnsLib.DotNetGateway.Service" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="DotNetVersion">4.5</Setting>
    <Setting Target="Host" Name="Exec64">1</Setting>
    <Setting Target="Host" Name="FilePath">C:\InterSystems\IRIS20201\dev\dotnet\bin\v4.5\</Setting>
    <Setting Target="Host" Name="Port">44445</Setting>
  </Item>
  <Item Name="EnsLib.File.PassthroughService" Category="" ClassName="EnsLib.File.PassthroughService" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="TargetConfigNames">S3Operation</Setting>
    <Setting Target="Adapter" Name="FilePath">C:\webinar\webinar-PEX\files\in</Setting>
  </Item>
  <Item Name="S3Service" Category="" ClassName="PEX.Webinar.AWSDemo.S3Service" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
    <Setting Target="Adapter" Name="%gatewayExtraClasspaths">C:\webinar\webinar-PEX\AWS\PEX.AWS\bin\Debug\netstandard2.0\PEX.AWS.dll;C:\Users\pyd\.nuget\packages\awssdk.s3\3.5.0-beta\lib\net45\AWSSDK.S3.DLL</Setting>
    <Setting Target="Adapter" Name="%remoteClassname">PEX.AWS.S3InboundAdapter</Setting>
    <Setting Target="Adapter" Name="%remoteSettings">awsAccessKeyId=AKIA6F7BHN5R63AZR3XJ
awsSecretAccessKey=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
awsBucket=iris-webinar
awsRegion=eu-west-1
archivePath=C:\\webinar\\webinar-PEX\\files\\archive</Setting>
    <Setting Target="Adapter" Name="CallInterval">30</Setting>
    <Setting Target="Adapter" Name="%gatewayPort">44445</Setting>
    <Setting Target="Host" Name="TargetConfigNames">EnsLib.File.PassthroughOperation</Setting>
  </Item>
  <Item Name="EnsLib.File.PassthroughOperation" Category="" ClassName="EnsLib.File.PassthroughOperation" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
    <Setting Target="Adapter" Name="FilePath">C:\webinar\webinar-PEX\files\out\</Setting>
    <Setting Target="Host" Name="Filename">%f</Setting>
  </Item>
</Production>
]]></Data>
</XData>
</Class>


<Class name="PEX.Webinar.AWSDemo.S3PutTextReq">
<Description>
Una Peticion para copia un fichero de texto a AWS</Description>
<Language>objectscript</Language>
<Super>Ens.Request</Super>
<TimeChanged>65516,61878.196428</TimeChanged>
<TimeCreated>65512,74531.37191</TimeCreated>

<Property name="ObjectName">
<Description>
S3 Key (Filename and Path)</Description>
<Type>%String</Type>
</Property>

<Property name="Data">
<Description>
The Data </Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>
</Class>


<Class name="PEX.Webinar.AWSDemo.S3Service">
<Description>
A Busines Service that reads and processes files from S3
This is a Simplified Version of Enslib.File.PassthroughService and EnsLib.File.InboundAdapter to handle files in S3
Note: this adapter deletes the files from S3 after processing them</Description>
<Language>objectscript</Language>
<Super>Ens.BusinessService</Super>
<TimeChanged>65516,61889.634674</TimeChanged>
<TimeCreated>65516,61889.634674</TimeCreated>

<Parameter name="ADAPTER">
<Default>EnsLib.PEX.InboundAdapter</Default>
</Parameter>

<Property name="TargetConfigNames">
<Description>
Configuration item(s) to which to send file stream messages</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="1000"/>
</Property>

<Parameter name="SETTINGS">
<Default><![CDATA[TargetConfigNames:Basic:selector?multiSelect=1&context={Ens.ContextSearch/ProductionItems?targets=1&productionName=@productionId}]]></Default>
</Parameter>

<Method name="OnProcessInput">
<FormalSpec>pFilename:%RegisteredObject,*pOutput:%RegisteredObject</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	$$$TRACE("Filename="_pFilename)
	//Get a Stream pointing to the filename. Just Binary here, but we could add options for CharacterStream and charsets selection
	set tStream=##class(%FileBinaryStream).%New()
	do tStream.LinkToFile(pFilename)
	Set tStream.Attributes("Filename")=pFilename
	
	//Build an IRIS Interoperability Message with the Stream
	set pInput=##class(Ens.StreamContainer).%New()	
	set pInput.Stream=tStream
	$$$SyncCommitSet(tSyncCommit)
	
	//And Send the message to all targets in the list of targetConfigname
	For iTarget=1:1:$L(..TargetConfigNames, ",") { Set tOneTarget=$ZStrip($P(..TargetConfigNames,",",iTarget),"<>W")  Continue:""=tOneTarget
		$$$sysTRACE("Sending input Stream "_pInput.Stream_"("_pInput.Stream.Size_") Async to '"_tOneTarget_"'")
	
		#; Since we are archiving locally, we can send the file Async as there is no risk of deleting it before the target has processed it
		Set tSC1=..SendRequestAsync(tOneTarget,pInput)  Set:$$$ISERR(tSC1) tSC=$$$ADDSC(tSC,tSC1)
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="OnGetConnections">
<Description>
Return an array of connections for drawing lines on the config diagram
Allows to correctly Display the Connections in the portal</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>*pArray:%String,pItem:Ens.Config.Item</FormalSpec>
<Implementation><![CDATA[
	Do ##super(.pArray,pItem)
	If pItem.GetModifiedSetting("TargetConfigNames",.tValue) {
		For i=1:1:$L(tValue,",") { Set tOne=$ZStrip($P(tValue,",",i),"<>W")  Continue:""=tOne  Set pArray(tOne)="" }
	}
]]></Implementation>
</Method>
</Class>


<Class name="PEX.Webinar.FirstDemo.DT.StringRequest2PEX">
<Super>Ens.DataTransformDTL</Super>
<TimeChanged>65516,61965.8313</TimeChanged>
<TimeCreated>65512,38966.304519</TimeCreated>
<DependsOn>Ens.StringRequest,EnsLib.PEX.Message</DependsOn>

<Parameter name="IGNOREMISSINGSOURCE">
<Default>1</Default>
</Parameter>

<Parameter name="REPORTERRORS">
<Default>1</Default>
</Parameter>

<Parameter name="TREATEMPTYREPEATINGFIELDASNULL">
<Default>0</Default>
</Parameter>

<XData name="DTL">
<XMLNamespace>http://www.intersystems.com/dtl</XMLNamespace>
<Data><![CDATA[
<transform sourceClass='Ens.StringRequest' targetClass='EnsLib.PEX.Message' create='new' language='objectscript' >
<annotation>Transforma un Ens.StringRequest al Mensaje PEX.Webinar.FirstDemo.FirstMessage</annotation>
<assign value='"PEX.Webinar.FirstDemo.FirstMessage"' property='target.%classname' action='set' />
<assign value='source.StringValue' property='target.%jsonObject.value' action='set' />
</transform>
]]></Data>
</XData>
</Class>


<Class name="PEX.Webinar.FirstDemo.MessageRouterRoutingRule">
<Description>
</Description>
<Super>Ens.Rule.Definition</Super>
<TimeChanged>65516,72864.943996</TimeChanged>
<TimeCreated>65511,58286.087216</TimeCreated>

<Parameter name="RuleAssistClass">
<Default>EnsLib.MsgRouter.RuleAssist</Default>
</Parameter>

<XData name="RuleDefinition">
<XMLNamespace>http://www.intersystems.com/rule</XMLNamespace>
<Data><![CDATA[
<ruleDefinition alias="" context="EnsLib.MsgRouter.RoutingEngine" production="PEX.Webinar.FirstDemo.Production">
<ruleSet name="" effectiveBegin="" effectiveEnd="">
<rule name="Enviar a BO de PEX">
<constraint name="msgClass" value="Ens.StringRequest"></constraint>
<when condition="1">
<send transform="PEX.Webinar.FistDemo.DT.StringRequest2PEX" target="FirstOperation"></send>
<return></return>
</when>
</rule>
</ruleSet>
</ruleDefinition>
]]></Data>
</XData>
</Class>


<Class name="PEX.Webinar.FirstDemo.Production">
<Super>Ens.Production</Super>
<TimeChanged>65516,79668.906435</TimeChanged>
<TimeCreated>65510,43736.834379</TimeCreated>

<XData name="ProductionDefinition">
<Data><![CDATA[
<Production Name="PEX.Webinar.FirstDemo" TestingEnabled="true" LogGeneralTraceEvents="false">
  <Description>Una Proucción de Demo para PEX</Description>
  <ActorPoolSize>2</ActorPoolSize>
  <Setting Target="Adapter" Name="ShutdownTimeout">20</Setting>
  <Item Name="DotNetGateway" Category="" ClassName="EnsLib.DotNetGateway.Service" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
    <Setting Target="Host" Name="FilePath">C:\InterSystems\IRIS20201\dev\dotnet\bin\v4.5\</Setting>
    <Setting Target="Host" Name="DotNetVersion">4.5</Setting>
    <Setting Target="Host" Name="Exec64">1</Setting>
    <Setting Target="Host" Name="Port">44444</Setting>
  </Item>
  <Item Name="FirstOperation" Category="" ClassName="EnsLib.PEX.BusinessOperation" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
    <Setting Target="Host" Name="%gatewayExtraClasspaths">C:\webinar\webinar-PEX\FirstDemo\PEX.Webinar.FirstDemo\bin\Debug\netstandard2.0\PEX.Webinar.FirstDemo.dll</Setting>
    <Setting Target="Host" Name="%gatewayPort">44444</Setting>
    <Setting Target="Host" Name="%remoteClassname">PEX.Webinar.FirstDemo.FirstOperation</Setting>
  </Item>
  <Item Name="MessageRouter" Category="" ClassName="EnsLib.MsgRouter.RoutingEngine" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="BusinessRuleName">PEX.Webinar.FirstDemo.MessageRouterRoutingRule</Setting>
    <Setting Target="Host" Name="ResponseFrom">FirstOperation</Setting>
  </Item>
  <Item Name="FirstService" Category="" ClassName="EnsLib.PEX.BusinessService" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
     <Setting Target="Host" Name="%gatewayExtraClasspaths">C:\webinar\webinar-PEX\FirstDemo\PEX.Webinar.FirstDemo\bin\Debug\netstandard2.0\PEX.Webinar.FirstDemo.dll</Setting>
    <Setting Target="Host" Name="%remoteClassname">PEX.Webinar.FirstDemo.FirstService</Setting>
    <Setting Target="Host" Name="%remoteSettings">TargetConfigName=FirstProcess</Setting>
  </Item>
  <Item Name="FirstProcess" Category="" ClassName="EnsLib.PEX.BusinessProcess" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="%gatewayExtraClasspaths">C:\webinar\webinar-PEX\FirstDemo\PEX.Webinar.FirstDemo\bin\Debug\netstandard2.0\PEX.Webinar.FirstDemo.dll</Setting>
    <Setting Target="Host" Name="%remoteClassname">PEX.Webinar.FirstDemo.FirstProcess</Setting>
    <Setting Target="Host" Name="%remoteSettings">Timeout=PT20S
TargetConfigName=FirstOperation</Setting>
  </Item>
</Production>
]]></Data>
</XData>
</Class>




<Project name="Webinar-PEX-DotNetSamples" LastModified="2020-05-17 20:07:29.652489">
  <Items>
    <ProjectItem name="PEX.Webinar" type="PKG"></ProjectItem>
  </Items>
</Project>
</Export>
